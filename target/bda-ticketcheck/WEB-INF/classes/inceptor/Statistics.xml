<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bda.bdaqm.electric.mapper.StatisticsMapper">
	<select id = "getAllData" resultType="com.bda.bdaqm.electric.model.Statistics">
		<!--  
		select * from gzpfx01.BDA_STATISTICS 
		<where>
		 1=1
		 <if test="timeBegin !=null and timeBegin !=''">
				and MONTH <![CDATA[>=]]> #{timeBegin}
		 </if>
		 <if test="timeEnd !=null and timeEnd !=''">
				and MONTH <![CDATA[<=]]> #{timeEnd}
		</if>
		<if test="type !=null and type !=''">
			    and UNIT = #{type}
		</if>
		</where>
		order by month desc,unit desc
		-->
		
					SELECT
				department_oid,
				baseId,
				department_oname,
				SUBSTRING( ins.work_end_time, 1, 7 ) MONTH,
				SUM( CASE ticket_type WHEN 11 THEN 1 ELSE 0 END ) stationOne,
				SUM( CASE ticket_type WHEN 12 THEN 1 ELSE 0 END ) stationTwo,
				SUM( CASE ticket_type WHEN 13 THEN 1 ELSE 0 END ) stationThree,
				SUM( CASE ticket_type WHEN 21 THEN 1 ELSE 0 END ) lineOne,
				SUM( CASE ticket_type WHEN 22 THEN 1 ELSE 0 END ) lineTwo,
				SUM( CASE ticket_type WHEN 31 THEN 1 ELSE 0 END ) fireOne,
				SUM( CASE ticket_type WHEN 32 THEN 1 ELSE 0 END ) fireTwo,
				SUM( CASE ticket_type WHEN 43 THEN 1 ELSE 0 END ) liveWorking,
				SUM( CASE ticket_type WHEN 44 THEN 1 ELSE 0 END ) lowVoltage,
				SUM( CASE ticket_type WHEN 51 THEN 1 ELSE 0 END ) urgentRepairs,
				SUM(CASE WHEN ticket_type is null then 1 else 0 end ) unMarked 
			FROM
				(
					SELECT DISTINCT
						so.org_id,
						so.org_name,
						so.parent_org_id,
						ba.department_oid,
						ba.ticket_type,
						ba.department_oname,
						ba.work_end_time,
						ba.id baseId
					FROM
						o_gea_lcam_sc_sp_pd_wticket_base ba,
						o_gea_lcam_sys_top_organization so 
					WHERE
						ba.department_oid = so.org_id 
						AND ba.work_end_time IS NOT NULL
				<if test="timeBegin !=null and timeBegin !=''">
						and SUBSTRING( ba.work_end_time, 1, 7 ) <![CDATA[>=]]> #{timeBegin}
		 		</if>
		 		<if test="timeEnd !=null and timeEnd !=''">
						and SUBSTRING( ba.work_end_time, 1, 7 ) <![CDATA[<=]]> #{timeEnd}
		 		</if>
		 		<if test="type !=null and type !=''">
			    		and ba.department_oid in ( select org_id from o_gea_lcam_sys_top_organization where name_full_path like #{type}	)
		 		</if>
				) ins
			WHERE
				department_oname IS NOT NULL 
			GROUP BY
				department_oname,
				baseId,
				department_oid,
				SUBSTRING( ins.work_end_time, 1, 7 )
		ORDER BY
		MONTH DESC
	</select>
	
	<select id="queryUnit" resultType = "map">
	  
	 select * from o_gea_lcam_sys_top_organization 
	  <!--
	  select * from (select * from o_gea_lcam_sc_sp_ss_so_safety_organization where organization_property ='10' ) tab
	  -->
	</select>
	<!--  
	<select id ="getOriginData" resultType="com.bda.bdaqm.electric.model.Original">
		select * from gzpfx01.BDA_ORIGINAL 
		where work_last_time_new =#{date} and operation like #{pattern} and ticket_type = #{type} 
	   
	   SELECT 
      base.id,
      base.work_task ,
      base.ticket_type,
      (select u1.user_name from o_gea_lcam_sc_sp_pd_wticket_user u1 where u1.user_id = base.work_principal_uid ) principal_name,
      base.department_oname,
      base.function_location_name,
      to_char(base.plan_start_time,'yyyy-MM-dd HH:mm:ss') plan_start_time,
      to_char(base.plan_end_time,'yyyy-MM-dd HH:mm:ss') plan_end_time,
      base.work_place,
      base.work_state,
      base.ticket_no,
      (select u2.user_name from o_gea_lcam_sc_sp_pd_wticket_user u2 where u2.user_id = base.ticket_sign_uid ) sign_name,
      to_char(base.ticket_sign_time,'yyyy-MM-dd HH:mm:ss') ticket_sign_time,
      (select u3.user_name from o_gea_lcam_sc_sp_pd_wticket_user u3 where u3.user_id = base.watch_uid ) watch_name,
      to_char(base.receive_time,'yyyy-MM-dd HH:mm:ss') receive_time,
      (select u4.user_name from o_gea_lcam_sc_sp_pd_wticket_user u4 where u4.user_id = base.work_permission_uid ) pmis_name,
      to_char(base.permission_time,'yyyy-MM-dd HH:mm:ss') permission_time,
      (select u5.user_name from o_gea_lcam_sc_sp_pd_wticket_user u5 where u5.user_id = base.work_end_permission_uid ) end_pmis_name,
      to_char(base.work_end_time,'yyyy-MM-dd HH:mm:ss') work_end_time,
      to_char(base.ticket_end_time,'yyyy-MM-dd HH:mm:ss') ticket_end_time, 
      to_char(exe.delay_time,'yyyy-MM-dd HH:mm:ss') delay_time
      FROM
			o_gea_lcam_sc_sp_pd_wticket_base base 
			LEFT JOIN o_gea_lcam_sc_sp_pd_wticket_execute exe ON (base.id = exe.wticket_id)
      where 
      		1=1
      		<if test="endMonth !=null and endMonth !=''">
			AND  SUBSTRING( base.work_end_time, 1, 7 ) <![CDATA[>=]]> #{date}  AND SUBSTRING( base.work_end_time, 1, 7 ) <![CDATA[<=]]> #{endMonth} 
		 	</if>
		 	<if test="endMonth==null or endMonth==''" >
		 	AND base.work_end_time like #{date}
		 	 </if>
		 	 <choose>
		 	     <when test = "type !=null and type !='' and type =='unMarked'">
		 	     AND base.ticket_type is null
		 	     </when>
		 	     <otherwise>
		 	     AND base.ticket_type = #{type}
		 	     </otherwise>
		 	 </choose>
		 	<if test="type !=null and type !='' and type!='unMarked'">
			 AND base.ticket_type = #{type}
		 	</if>
      		
      		AND base.id in
      		<foreach collection="list" item="item" index="index" open="(" separator="," close=")">#{item}</foreach>
	</select>
	-->
	
	<select id ="getOriginData" resultType="com.bda.bdaqm.electric.model.Original">
		SELECT * FROM (
	
							SELECT tab.id,tab.work_task,tab.ticket_type,tab.department_oid,tab.work_end_time,tab.department_oname,tab.work_state,
							tab.function_location_name,to_char(tab.plan_start_time,'yyyy-MM-dd HH:mm:ss') plan_start_time,to_char(tab.plan_end_time,'yyyy-MM-dd HH:mm:ss') plan_end_time,tab.work_place,
      						tab.work_state, tab.ticket_no,tab.ticket_sign_time,tab.receive_time,tab.permission_time,tab.ticket_end_time,tab.sign_name,tab.pmis_name,tab.end_pmis_name,tab.principal_name,
      						tab.delay_time,tab.ticket_end_time,tab.watch_name,
      						
							(SELECT u2.name_full_path FROM o_gea_lcam_sys_top_organization u2 WHERE u2.org_id = tab.permission_name_top )permission_unit_name,
							(SELECT u3.name_full_path FROM o_gea_lcam_sys_top_organization u3 WHERE u3.org_id = tab.sign_name_top )sign_unit_name,
							(SELECT q1.name_full_path FROM o_gea_lcam_sys_top_organization q1 WHERE q1.org_id = tab.department_oid) departName from
								(SELECT base.*,to_char(exe.delay_time,'yyyy-MM-dd HH:mm:ss') delay_time,
	   								( SELECT u4.org_id FROM o_gea_lcam_sys_top_user u4 WHERE u4.user_id = base.work_permission_uid 	) permission_name_top,
	   								( SELECT u5.org_id FROM o_gea_lcam_sys_top_user u5 WHERE u5.user_id = base.ticket_sign_uid 	) sign_name_top, 
      								(select q2.user_name from o_gea_lcam_sc_sp_pd_wticket_user q2 where q2.user_id = base.ticket_sign_uid ) sign_name,
      								(select q3.user_name from o_gea_lcam_sc_sp_pd_wticket_user q3 where q3.user_id = base.watch_uid ) watch_name,
      								(select u1.user_name from o_gea_lcam_sc_sp_pd_wticket_user u1 where u1.user_id = base.work_principal_uid ) principal_name,
      								(select q4.user_name from o_gea_lcam_sc_sp_pd_wticket_user q4 where q4.user_id = base.work_end_permission_uid ) end_pmis_name,
      								(select q5.user_name from o_gea_lcam_sc_sp_pd_wticket_user q5 where q5.user_id = base.work_permission_uid ) pmis_name
      								FROM o_gea_lcam_sc_sp_pd_wticket_base base 
      								LEFT JOIN o_gea_lcam_sc_sp_pd_wticket_execute exe ON (base.id = exe.wticket_id)
       							)tab
       							
       				)zxc  WHERE 
       				 (sign_unit_name like concat('%',#{unit}) OR permission_unit_name like concat('%',#{unit}) OR departName LIKE concat('%',#{unit})) 
       				<choose>
		 	     		<when test = "type !=null and type !='' and type =='unMarked'">
		 	     		AND zxc.ticket_type is null
		 	    		</when>
		 	    		<when test = "type !=null and type !='' and type =='inferno'">
		 	     		
		 	    		</when>
		 	     		<otherwise>
		 	     		AND zxc.ticket_type = #{type}
		 	     		</otherwise>
		 	 		</choose> 
       				  <if test="endMonth !=null and endMonth !=''">
						AND  SUBSTRING( zxc.work_end_time, 1, 7 ) <![CDATA[>=]]> #{date}  AND SUBSTRING( zxc.work_end_time, 1, 7 ) <![CDATA[<=]]> #{endMonth} 
		 			  </if>
		 	          <if test="endMonth==null or endMonth==''" >
		 				AND zxc.work_end_time like #{date}
		 	 		  </if>     				
	</select>
	<select id = "getComboxTree" resultType = "com.bda.bdaqm.electric.model.ComboxTree">
		select org_id childrenId,parent_org_id fatherId, org_name name,org_level level  from o_gea_lcam_sys_top_organization where org_id not in (select org_id from o_gea_lcam_sys_top_organization where org_name like '%已注销%')
	</select>
	
	<select id="getComboxTreeZP" resultType="java.lang.String">
		select t1.org_id orgId  FROM 
			gzpfx01.bda_work_dept t2 INNER JOIN o_gea_lcam_sys_top_organization t1
			ON t1.org_id=SUBSTRING(t2.department_id,12)
	</select>
	
	<select id = "getComboxSql" resultType = "com.bda.bdaqm.util.ComboBoxItem">
	  select org_name as TEXT, org_name as  VALUE from o_gea_lcam_sys_top_organization where parent_org_id ='-1' or parent_org_id = '1589BAA876FDBD64E053380F0A0A54B2' and org_id not in (select org_id from o_gea_lcam_sys_top_organization where org_name like '%已注销%')
	</select>
	
	<select id="getZWComboxSql" resultType = "com.bda.bdaqm.util.ComboBoxItem">
	  select department_short_name as TEXT , department_name as VALUE from gzpfx01.bda_work_dept where busi_cd = #{unitType}
	  and department_short_name not in ('基建部','输电所','通信中心','试研院')
	</select>
	
	<select id ="getPermission" resultType = "com.bda.bdaqm.electric.model.StatisticsVo">
		SELECT temp.* FROM 
		(
			select zxc.departName,zxc.id,zxc.ticket_type,zxc.department_oid,SUBSTRING( zxc.work_end_time, 1, 7 ) work_end_time,zxc.department_oname,zxc.permission_unit_name,zxc.sign_unit_name

			from(

					SELECT tab.id,tab.ticket_type,tab.department_oid,tab.work_end_time,tab.department_oname,(SELECT u2.name_full_path FROM o_gea_lcam_sys_top_organization u2 WHERE u2.org_id = tab.permission_name )permission_unit_name,
							(SELECT u3.name_full_path FROM o_gea_lcam_sys_top_organization u3 WHERE u3.org_id = tab.sign_name )sign_unit_name,
							(SELECT q1.name_full_path FROM o_gea_lcam_sys_top_organization q1 WHERE q1.org_id = tab.department_oid) departName from
								(SELECT base.*,
	   								( SELECT u4.org_id FROM o_gea_lcam_sys_top_user u4 WHERE u4.user_id = base.work_permission_uid 	) permission_name,
	   								( SELECT u5.org_id FROM o_gea_lcam_sys_top_user u5 WHERE u5.user_id = base.ticket_sign_uid 	) sign_name 
      								FROM o_gea_lcam_sc_sp_pd_wticket_base base WHERE  base.work_end_time IS NOT NULL  AND base.department_oid IS NOT NULL 
      								<if test="timeBegin !=null and timeBegin !=''">
										and SUBSTRING( base.work_end_time, 1, 7 ) <![CDATA[>=]]> #{timeBegin}
		 							</if>
		 							<if test="timeEnd !=null and timeEnd !=''">
										and SUBSTRING( base.work_end_time, 1, 7 ) <![CDATA[<=]]> #{timeEnd}
		 							</if>
       							)tab
			)zxc 
			 <if test="type !=null and type !=''">
			 WHERE permission_unit_name like #{type}
		 	</if>
			
		) temp WHERE temp.permission_unit_name<![CDATA[<>]]>temp.departName and temp.permission_unit_name is not null
	</select>
	
	
	
	<select id="getSign" resultType = "com.bda.bdaqm.electric.model.StatisticsVo">
		SELECT temp.* FROM 
		(
			select zxc.departName,zxc.id,zxc.ticket_type,zxc.department_oid,SUBSTRING( zxc.work_end_time, 1, 7 ) work_end_time,zxc.department_oname,zxc.permission_unit_name,zxc.sign_unit_name

			from(

					SELECT tab.id,tab.ticket_type,tab.department_oid,tab.work_end_time,tab.department_oname,(SELECT u2.name_full_path FROM o_gea_lcam_sys_top_organization u2 WHERE u2.org_id = tab.permission_name )permission_unit_name,
							(SELECT u3.name_full_path FROM o_gea_lcam_sys_top_organization u3 WHERE u3.org_id = tab.sign_name )sign_unit_name,
							(SELECT q1.name_full_path FROM o_gea_lcam_sys_top_organization q1 WHERE q1.org_id = tab.department_oid) departName from
								(SELECT base.*,
	   								( SELECT u4.org_id FROM o_gea_lcam_sys_top_user u4 WHERE u4.user_id = base.work_permission_uid 	) permission_name,
	   								( SELECT u5.org_id FROM o_gea_lcam_sys_top_user u5 WHERE u5.user_id = base.ticket_sign_uid 	) sign_name 
      							FROM o_gea_lcam_sc_sp_pd_wticket_base base WHERE  base.work_end_time IS NOT NULL AND base.department_oid IS NOT NULL 
      								<if test="timeBegin !=null and timeBegin !=''">
										and SUBSTRING( base.work_end_time, 1, 7 ) <![CDATA[>=]]> #{timeBegin}
		 							</if>
		 							<if test="timeEnd !=null and timeEnd !=''">
										and SUBSTRING( base.work_end_time, 1, 7 ) <![CDATA[<=]]> #{timeEnd}
		 							</if>
      							
       							)tab
			)zxc WHERE permission_unit_name <![CDATA[<>]]>sign_unit_name 
			<if test="type !=null and type !=''">
			 and sign_unit_name like #{type}
		 	</if>
			
		) temp WHERE temp.sign_unit_name<![CDATA[<>]]>temp.departName and temp.sign_unit_name is not null
	</select>
	
	
	<select id = "getExterNalUnit" resultType="com.bda.bdaqm.electric.model.Statistics">
							SELECT
				department_oid,
				baseId,
				department_oname,
				count(baseId) total
			FROM
				(
					SELECT DISTINCT
						so.org_id,
						so.org_name,
						so.parent_org_id,
						ba.department_oid,
						ba.ticket_type,
						ba.department_oname,
						ba.work_end_time,
						ba.id baseId
					FROM
						o_gea_lcam_sc_sp_pd_wticket_base ba,
						o_gea_lcam_sys_top_organization so 
					WHERE
						ba.department_oid = so.org_id 
						AND ba.work_end_time IS NOT NULL
						and SUBSTRING( ba.work_end_time, 1, 7 ) <![CDATA[>=]]> #{timeBegin}
						and SUBSTRING( ba.work_end_time, 1, 7 ) <![CDATA[<=]]> #{timeEnd}
			    		and ba.department_oid in ( select org_id from o_gea_lcam_sys_top_organization where name_full_path like '%外协单位%'	)
				) ins
			WHERE 
				department_oname IS NOT NULL 
			GROUP BY
				department_oname,
				baseId,
				department_oid;
	
	</select>
	
</mapper>