<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bda.bdaqm.electric.mapper.TicketTypeStatisticMapper">
	<!--  
	<select id = "statisticQualified" resultType = "com.bda.bdaqm.electric.model.TicketTypeStatistic">
		SELECT sum(CASE check_result WHEN 0 THEN 1 ELSE 0 END  ) qualified,
			   sum(CASE check_result WHEN 1 THEN 1 ELSE 0 END  ) noQualified, 
			   sum(CASE standard_result WHEN 0 THEN 1 ELSE 0 END  ) standard,
			   sum(CASE standard_result WHEN 1 THEN 1 ELSE 0 END  ) noStandard,
			   SUBSTRING( work_end_time, 1, 7 ) time
		FROM gzpfx01.bda_analysis_statistic 
		WHERE
		1=1
		<if test="beginMonth !=null and beginMonth !=''">
			AND SUBSTRING( work_end_time, 1, 7 ) <![CDATA[>=]]> #{beginMonth}
		</if>
		
		<if test="endMonth !=null and endMonth !=''">
			AND SUBSTRING( work_end_time, 1, 7 ) <![CDATA[<=]]> #{endMonth}
		</if>
		
		<if test = "unit !=null and unit != ''">
			AND name_full_path like #{unit}
		</if>
		 
		GROUP BY time;
	</select>
	-->
	
	<select id="statisticTicketType" resultType = "com.bda.bdaqm.electric.model.TicketTypeStatistic">
		SELECT 			
				SUBSTRING( work_end_time, 1, 7 ) time,
				SUM( CASE ticket_type WHEN 11 THEN 1 ELSE 0 END ) stationOne,
				SUM( CASE ticket_type WHEN 12 THEN 1 ELSE 0 END ) stationTwo,
				SUM( CASE ticket_type WHEN 13 THEN 1 ELSE 0 END ) stationThree,
				SUM( CASE ticket_type WHEN 21 THEN 1 ELSE 0 END ) lineOne,
				SUM( CASE ticket_type WHEN 22 THEN 1 ELSE 0 END ) lineTwo,
				SUM( CASE ticket_type WHEN 31 THEN 1 ELSE 0 END ) fireOne,
				SUM( CASE ticket_type WHEN 32 THEN 1 ELSE 0 END ) fireTwo,
				SUM( CASE ticket_type WHEN 43 THEN 1 ELSE 0 END ) liveWorking,
				SUM( CASE ticket_type WHEN 44 THEN 1 ELSE 0 END ) lowVoltage,
				SUM( CASE ticket_type WHEN 51 THEN 1 ELSE 0 END ) urgentRepairs,
				SUM(CASE check_result WHEN 0 THEN 1 ELSE 0 END  ) qualified,
				SUM(CASE check_result WHEN 0 THEN 0 ELSE 1 END  ) noQualified, 
				SUM(CASE standard_result WHEN 0 THEN 1 ELSE 0 END  ) standard,
				SUM(CASE standard_result WHEN 1 THEN 1 ELSE 0 END  ) noStandard,
				SUM( CASE SUBSTRING(name_full_path,0,4) WHEN  '外协单位' THEN 1 ELSE 0 END)  constructUnit,
	   			SUM( CASE SUBSTRING(name_full_path,0,4) WHEN  '外协单位' THEN 0 ELSE 1 END)  principal
		FROM 
				gzpfx01.bda_analysis_statistic 
		WHERE
		1=1
		<if test="beginMonth !=null and beginMonth !=''">
			AND SUBSTRING( work_end_time, 1, 7 ) <![CDATA[>=]]> #{beginMonth}
		</if>
		
		<if test="endMonth !=null and endMonth !=''">
			AND SUBSTRING( work_end_time, 1, 7 ) <![CDATA[<=]]> #{endMonth}
		</if>
		
		<if test = "unit !=null and unit != ''">
			AND name_full_path like  concat('%',#{unit},'%')
		</if>
		GROUP BY time;
	</select>
	
	
	<!--  
	<select id = "statisticPrincipal" resultType = "com.bda.bdaqm.electric.model.TicketTypeStatistic">
		
		SELECT 
				SUM( CASE SUBSTRING(name_full_path,0,4) WHEN  '外协单位' THEN 1 ELSE 0 END)  constructUnit,
	   			SUM( CASE SUBSTRING(name_full_path,0,4) WHEN  '外协单位' THEN 0 ELSE 1 END)  principal ,
       			SUBSTRING( work_end_time, 1, 7 ) time
		FROM gzpfx01.bda_analysis_statistic
		WHERE
		1=1
		<if test="beginMonth !=null and beginMonth !=''">
			AND SUBSTRING( work_end_time, 1, 7 ) <![CDATA[>=]]> #{beginMonth}
		</if>
		
		<if test="endMonth !=null and endMonth !=''">
			AND SUBSTRING( work_end_time, 1, 7 ) <![CDATA[<=]]> #{endMonth}
		</if>
		
		<if test = "unit !=null and unit != ''">
			AND name_full_path like #{unit}
		</if>
		GROUP BY time;
		
	</select>
	-->
	
	<select id="getDelayData" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
	 	select * from gzpfx01.bda_analysis_statistic
	 	WHERE
		1=1
		<if test="beginMonth !=null and beginMonth !=''">
			AND SUBSTRING( work_end_time, 1, 7 ) <![CDATA[>=]]> #{beginMonth}
		</if>
		
		<if test="endMonth !=null and endMonth !=''">
			AND SUBSTRING( work_end_time, 1, 7 ) <![CDATA[<=]]> #{endMonth}
		</if>
		
		<if test = "unit !=null and unit != ''">
			AND name_full_path like  concat('%',#{unit},'%')
		</if>
	</select>
	
	<select id="getExtriDelayData" resultType="map">
	 	select * from gzpfx01.bda_analysis_statistic
	 	WHERE
		name_full_path like '%外协单位%'
		<if test="beginMonth !=null and beginMonth !=''">
			AND SUBSTRING( work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginMonth}
		</if>
		
		<if test="endMonth !=null and endMonth !=''">
			AND SUBSTRING( work_end_time, 1, 10 ) <![CDATA[<=]]> #{endMonth}
		</if>
		<!--  
		<if test = "unit !=null and unit != ''">
			AND name_full_path like  concat('%',#{unit},'%')
		</if>
		-->
	</select>
	
	<select id = "statisticTypeForUnit" resultType="map"> 
		SELECT substr(name_full_path,instr(name_full_path,'/',1,2)+1,instr(name_full_path,'/',1,3)-instr(name_full_path,'/',1,2)-1) unitName,
			   SUM( CASE ticket_type WHEN 11 THEN 1 ELSE 0 END ) stationOne,
			   SUM( CASE ticket_type WHEN 12 THEN 1 ELSE 0 END ) stationTwo,
			   SUM( CASE ticket_type WHEN 13 THEN 1 ELSE 0 END ) stationThree,
			   SUM( CASE ticket_type WHEN 21 THEN 1 ELSE 0 END ) lineOne,
			   SUM( CASE ticket_type WHEN 22 THEN 1 ELSE 0 END ) lineTwo,
			   SUM( CASE ticket_type WHEN 31 THEN 1 ELSE 0 END ) fireOne,
			   SUM( CASE ticket_type WHEN 32 THEN 1 ELSE 0 END ) fireTwo,
			   SUM( CASE ticket_type WHEN 43 THEN 1 ELSE 0 END ) liveWorking,
			   SUM( CASE ticket_type WHEN 44 THEN 1 ELSE 0 END ) lowVoltage,
			   SUM( CASE ticket_type WHEN 51 THEN 1 ELSE 0 END ) urgentRepairs,
			   SUM( CASE ticket_type WHEN 88 THEN 1 ELSE 0 END ) dispatch,
			   count(*) - count(ticket_type) AS unMarked
		 FROM gzpfx01.bda_analysis_statistic WHERE name_full_path NOT LIKE '%外协单位%' 
		 <if test="beginMonth !=null and beginMonth !=''">
			AND SUBSTRING( work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginMonth}
		</if>
		
		<if test="endMonth !=null and endMonth !=''">
			AND SUBSTRING( work_end_time, 1, 10 ) <![CDATA[<=]]> #{endMonth}
		</if>
		 GROUP BY unitName
	
	</select>
	
	<select id ="statisticTypeForAll" resultType="map">
		SELECT 
			SUM( CASE ticket_type WHEN 11 THEN 1 ELSE 0 END ) stationOne,
			SUM( CASE ticket_type WHEN 12 THEN 1 ELSE 0 END ) stationTwo,
			SUM( CASE ticket_type WHEN 13 THEN 1 ELSE 0 END ) stationThree,
			SUM( CASE ticket_type WHEN 21 THEN 1 ELSE 0 END ) lineOne,
			SUM( CASE ticket_type WHEN 22 THEN 1 ELSE 0 END ) lineTwo,
			SUM( CASE ticket_type WHEN 31 THEN 1 ELSE 0 END ) fireOne,
			SUM( CASE ticket_type WHEN 32 THEN 1 ELSE 0 END ) fireTwo,
			SUM( CASE ticket_type WHEN 43 THEN 1 ELSE 0 END ) liveWorking,
			SUM( CASE ticket_type WHEN 44 THEN 1 ELSE 0 END ) lowVoltage,
			SUM( CASE ticket_type WHEN 51 THEN 1 ELSE 0 END ) urgentRepairs,
			SUM( CASE ticket_type WHEN 88 THEN 1 ELSE 0 END ) dispatch,
			count(*) - count(ticket_type) AS unMarked, 
			SUBSTRING(name_full_path,0,4) unitName
			FROM gzpfx01.bda_analysis_statistic 
			where 1=1
			<if test="beginMonth !=null and beginMonth !=''">
			AND SUBSTRING( work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginMonth}
			</if>
			<if test="endMonth !=null and endMonth !=''">
			AND SUBSTRING( work_end_time, 1, 10 ) <![CDATA[<=]]> #{endMonth}
			</if>
			GROUP BY unitName
	</select>
	
	<select id="statisticPrincipal" resultType="map">
		SELECT 			
				SUM( CASE SUBSTRING(name_full_path,0,4) WHEN  '外协单位' THEN 1 ELSE 0 END)  constructUnit,
	   			SUM( CASE SUBSTRING(name_full_path,0,4) WHEN  '外协单位' THEN 0 ELSE 1 END)  principal,
	   			substr(name_full_path,instr(name_full_path,'/',1,2)+1,instr(name_full_path,'/',1,3)-instr(name_full_path,'/',1,2)-1) unitName
		FROM 
				gzpfx01.bda_analysis_statistic 
		WHERE name_full_path NOT LIKE '%外协单位%'
		<if test="beginMonth !=null and beginMonth !=''">
			AND SUBSTRING( work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginMonth}
		</if>
		<if test="endMonth !=null and endMonth !=''">
			AND SUBSTRING( work_end_time, 1, 10 ) <![CDATA[<=]]> #{endMonth}
		</if>
		GROUP BY unitName
	</select>
	
	<select id="statisticPermission" resultType="map">
	
		SELECT 
				SUM( CASE SUBSTRING(name_full_path,0,4) WHEN  '外协单位' THEN 0 ELSE 1 END)  constructUnit, 
				SUM( CASE SUBSTRING(name_full_path,0,4) WHEN  '外协单位' THEN 1 ELSE 0 END)  principal,
				substr(name_full_path,instr(name_full_path,'/',1,2)+1,instr(name_full_path,'/',1,3)-instr(name_full_path,'/',1,2)-1) unitName
		FROM(SELECT tab.ticket_id,tab.ticket_type,org.name_full_path,tab.orgId FROM o_gea_lcam_sys_top_organization org ,(SELECT st.*,us.org_id orgId FROM gzpfx01.bda_analysis_statistic st , o_gea_lcam_sys_top_user us WHERE  st.work_permission_uid = us.user_id AND st.name_full_path LIKE '%外协单位%'
			)tab 
		WHERE tab.orgId = org.org_id
		<if test="beginMonth !=null and beginMonth !=''">
			AND SUBSTRING( work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginMonth}
		</if>
		<if test="endMonth !=null and endMonth !=''">
			AND SUBSTRING( work_end_time, 1, 10 ) <![CDATA[<=]]> #{endMonth}
		</if>) atemp
		GROUP BY unitName
	
	</select>
	
	<select id = "statictisState" resultType="map">
		SELECT count(work_state) num, work_state FROM gzpfx01.bda_state_statistic 
		<if test="beginMonth !=null and beginMonth !=''">
			where SUBSTRING( update_time, 1, 10 ) <![CDATA[>=]]> #{beginMonth}
		</if>
		<if test="endMonth !=null and endMonth !=''">
			AND SUBSTRING( update_time, 1, 10 ) <![CDATA[<=]]> #{endMonth}
		</if>
		GROUP BY work_state
	</select>
	
	
	<insert id = "insertStateStatistic">
		INSERT INTO  gzpfx01.bda_state_statistic 
	SELECT gzpfx01.seq_state_id.nextval AS id,id AS ticket_id,ticket_no,ticket_type,function_location_name,
	work_task,department_oname,work_principal_uid,major,work_permission_uid,ticket_sign_uid,work_state,
	permission_time,work_end_time,update_time FROM o_gea_lcam_sc_sp_pd_wticket_base 
	WHERE src_operation_type <![CDATA[<>]]> 'D' AND SUBSTRING( update_time, 1, 10 ) <![CDATA[>=]]> #{beginTime} AND  SUBSTRING( update_time, 1, 10 ) <![CDATA[<=]]> #{endTime};
		
	</insert>
	
	
	<select id = "selectDetailDialog" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT bat.ticket_no,bat.ticket_type,bat.function_location_name,bat.work_task,bat.org_name,bat.work_state,
		to_char(bat.permission_time,'yyyy-MM-dd HH:mm:ss') permission_time,
		to_char(bat.work_end_time,'yyyy-MM-dd HH:mm:ss') work_end_time,
		to_char(bat.plan_start_time,'yyyy-MM-dd HH:mm:ss')plan_start_time,
		to_char(bat.plan_end_time,'yyyy-MM-dd HH:mm:ss')plan_end_time,
		bat.check_result,bat.standard_result,
		bat.is_delay,
		(select u1.user_name from o_gea_lcam_sc_sp_pd_wticket_user u1 where u1.user_id = bat.ticket_sign_uid ) signName,
		(select u2.user_name from o_gea_lcam_sc_sp_pd_wticket_user u2 where u2.user_id = bat.work_principal_uid ) principalName,
		(select u3.user_name from o_gea_lcam_sc_sp_pd_wticket_user u3 where u3.user_id = bat.work_permission_uid ) pmisName FROM gzpfx01.bda_analysis_statistic bat where 
		SUBSTRING( bat.work_end_time, 1, 7 ) == #{endMonth}
		<if test="flag !=null and flag !='' and flag ==0 ">
			and bat.check_result = '0'
		</if>
		<if test="flag !=null and flag !='' and flag ==1 ">
			and bat.check_result = '1'
		</if>
		<if test="staFlag !=null and staFlag !='' and staFlag ==0 ">
			and bat.standard_result = '0'
		</if>
		<if test="staFlag !=null and staFlag !='' and staFlag ==1 ">
			and bat.standard_result = '1'
		</if>
		<if test="ticketType !=null and ticketType !='' and ticketType != '' ">
			and bat.ticket_type = #{ticketType} 
		</if>
		<if test="fullPath !=null and fullPath !='' and fullPath == 0 ">
			and bat.name_full_path like '%外协单位%' 
		</if>
		<if test="fullPath !=null and fullPath !='' and fullPath == 1 ">
			and bat.name_full_path not like '%外协单位%' 
		</if>
		<if test="isDelay !=null and isDelay !='' and isDelay == 1 ">
			and bat.is_delay == '1'  
		</if>
		<if test = "unit !=null and unit !=''">
			and bat.name_full_path like concat('%',#{unit},'%')
		</if>	 
	
	</select>
	
	
	<select id ="selectAllTypeDialog" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT bat.ticket_no,bat.ticket_type,bat.function_location_name,bat.work_task,bat.org_name,bat.work_state,
			to_char(bat.permission_time,'yyyy-MM-dd HH:mm:ss') permission_time,
			to_char(bat.work_end_time,'yyyy-MM-dd HH:mm:ss') work_end_time,
			to_char(bat.plan_start_time,'yyyy-MM-dd HH:mm:ss')plan_start_time,
			to_char(bat.plan_end_time,'yyyy-MM-dd HH:mm:ss')plan_end_time,
			bat.check_result,bat.standard_result,
			bat.is_delay,
			(select u1.user_name from o_gea_lcam_sc_sp_pd_wticket_user u1 where u1.user_id = bat.ticket_sign_uid ) signName,
			(select u2.user_name from o_gea_lcam_sc_sp_pd_wticket_user u2 where u2.user_id = bat.work_principal_uid ) principalName,
			(select u3.user_name from o_gea_lcam_sc_sp_pd_wticket_user u3 where u3.user_id = bat.work_permission_uid ) pmisName FROM gzpfx01.bda_analysis_statistic bat where 
			 SUBSTRING( bat.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endMonth}
			AND SUBSTRING( bat.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginMonth}
			
			<if test = "isDelay!=null and isDelay!='' and isDelay == 1">
			AND	bat.is_delay = '1'	
			</if>
			
			<if test = "typeFlag!=null and typeFlag!='' and typeFlag == 8">
			AND	bat.ticket_type is null 		
			</if>
			
			<if test = "typeFlag!=null and typeFlag!='' and typeFlag == 8">
			AND	bat.ticket_type is null 		
			</if>
			
			<if test = "typeFlag!=null and typeFlag!='' and typeFlag == 0">
			AND	bat.ticket_type = #{ticketType}			
			</if>
			
			<if test = "typeFlag!=null and typeFlag!='' and typeFlag == 1">
			AND	bat.check_result = '0' AND	bat.ticket_type = #{ticketType}			
			</if>
			
			<if test = "typeFlag!=null and typeFlag!='' and typeFlag == 2">
			AND	bat.is_delay = '1' AND	bat.ticket_type = #{ticketType}			
			</if>	
			<choose>
        		<when test="isExtrl !=null and isExtrl !='' and isExtrl == 2">
            		AND	bat.name_full_path  like '%外协单位%' 		
        		</when>
        		<when test="isExtrl !=null and isExtrl !='' and isExtrl == 8">
        			AND	bat.name_full_path  not like '%外协单位%'
        		</when> 
        		<otherwise>
            		AND	bat.name_full_path like concat('%',#{unit},'%')	
        		</otherwise>
    		</choose>
    		<!--  			
			<if test = "isExtrl !=null and isExtrl !='' and isExtrl =2">
			AND	bat.name_full_path  like '%外协单位%' 			
			</if>
			
			<if test = "">
			AND	bat.name_full_path like concat('%',#{unit},'%')			
			</if>
    		-->
    		
	</select>
	
	
	<select id = "selectAllTypePermissionDialog" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT tab.ticket_id,tab.ticket_type,org.name_full_path,tab.orgId,
			tab.ticket_no,tab.function_location_name,tab.work_task,tab.org_name,tab.work_state,
			to_char(tab.permission_time,'yyyy-MM-dd HH:mm:ss') permission_time,
			to_char(tab.work_end_time,'yyyy-MM-dd HH:mm:ss') work_end_time,
			to_char(tab.plan_start_time,'yyyy-MM-dd HH:mm:ss')plan_start_time,
			to_char(tab.plan_end_time,'yyyy-MM-dd HH:mm:ss')plan_end_time,
			tab.check_result,tab.standard_result,
			tab.is_delay,
			(select u1.user_name from o_gea_lcam_sc_sp_pd_wticket_user u1 where u1.user_id = tab.ticket_sign_uid ) signName,
			(select u2.user_name from o_gea_lcam_sc_sp_pd_wticket_user u2 where u2.user_id = tab.work_principal_uid ) principalName,
			(select u3.user_name from o_gea_lcam_sc_sp_pd_wticket_user u3 where u3.user_id = tab.work_permission_uid ) pmisName

		FROM o_gea_lcam_sys_top_organization org ,(SELECT st.*,us.org_id orgId FROM gzpfx01.bda_analysis_statistic st , o_gea_lcam_sys_top_user us WHERE  st.work_permission_uid = us.user_id AND st.name_full_path LIKE '%外协单位%'
			)tab 
		WHERE tab.orgId = org.org_id
			AND SUBSTRING( tab.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endMonth} 	
			AND SUBSTRING( tab.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginMonth}
			AND org.name_full_path LIKE concat('%',#{unit},'%')

	</select>
	
	<select id ="selectStateDialog" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
	   SELECT bss.ticket_No,bss.ticket_type,bss.function_location_name,bss.work_task,bss.department_oname orgName,bss.work_state,
          to_char(bss.permission_time,'yyyy-MM-dd HH:mm:ss') permission_time,
		  to_char(bss.work_end_time,'yyyy-MM-dd HH:mm:ss') work_end_time,
		  (select u1.user_name from o_gea_lcam_sc_sp_pd_wticket_user u1 where u1.user_id = bss.ticket_sign_uid ) signName,
		  (select u2.user_name from o_gea_lcam_sc_sp_pd_wticket_user u2 where u2.user_id = bss.work_principal_uid ) principalName,
		  (select u3.user_name from o_gea_lcam_sc_sp_pd_wticket_user u3 where u3.user_id = bss.work_permission_uid ) pmisName
       FROM   
          gzpfx01.bda_state_statistic bss 
       WHERE  SUBSTRING( bss.update_time, 1, 10 )  <![CDATA[<=]]> #{endMonth}
			AND SUBSTRING( bss.update_time, 1, 10 ) <![CDATA[>=]]> #{beginMonth}
	   <if test="stateType!=null and stateType!=''">
	   		AND bss.work_state =#{stateType}
	   </if>
	</select>
	
	
</mapper>