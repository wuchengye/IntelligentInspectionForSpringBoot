<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bda.bdaqm.electric.mapper.TicketExploreMapper">
	<select id="getUnitNumAndCheck" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
				bds.standard_result standardResult,bds.name_full_path nameFullPath,
				to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
				to_char(bds.plan_end_time) planEndTime,
				bds.org_id,bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
				bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
				to_char(bds.plan_start_time) as planStartTime,
				user1.user_name principalName,user2.user_name pmisName,
				user3.user_name signName 
				from gzpfx01.bda_analysis_statistic bds
				left join o_gea_lcam_sc_sp_pd_wticket_user user1
				on user1.user_id = bds.work_principal_uid 
				left join o_gea_lcam_sc_sp_pd_wticket_user user2
				on user2.user_id = bds.work_permission_uid
				left join o_gea_lcam_sc_sp_pd_wticket_user user3
				on user3.user_id = bds.ticket_sign_uid
			WHERE SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginTime}
			AND SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endTime}
			<if test="unit != null and unit != ''">
				AND bds.name_full_path REGEXP(#{unit})
			</if>
			<if test="seriesIndex == 1">
				and bds.check_result = '0'
			</if>
			<if test="seriesIndex == 2">
				and bds.check_result = '0' 
				and bds.standard_result = '0'
			</if>
	</select>
	
	<select id="getUnitDelayNumTime" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
				bds.standard_result standardResult,bds.name_full_path nameFullPath,
				to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
				to_char(bds.plan_end_time) planEndTime,
				bds.org_id,bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
				bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
				to_char(bds.plan_start_time) as planStartTime,
				user1.user_name principalName,user2.user_name pmisName,
				user3.user_name signName 
				from gzpfx01.bda_analysis_statistic bds
				left join o_gea_lcam_sc_sp_pd_wticket_user user1
				on user1.user_id = bds.work_principal_uid 
				left join o_gea_lcam_sc_sp_pd_wticket_user user2
				on user2.user_id = bds.work_permission_uid
				left join o_gea_lcam_sc_sp_pd_wticket_user user3
				on user3.user_id = bds.ticket_sign_uid
			WHERE SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginTime}
			AND SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endTime}
			<if test="unit != null and unit != ''">
				AND bds.name_full_path REGEXP(#{unit}) 
			</if>
			and bds.is_delay = '1'
	</select>
	
	<select id="getKVLevelNum" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
	SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
				bds.standard_result standardResult,bds.name_full_path nameFullPath,
				to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
				to_char(bds.plan_end_time) planEndTime,
				bds.org_id,bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
				bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
				to_char(bds.plan_start_time) as planStartTime,
				user1.user_name principalName,user2.user_name pmisName,
				user3.user_name signName 
				from gzpfx01.bda_analysis_statistic bds
				left join o_gea_lcam_sc_sp_pd_wticket_user user1
				on user1.user_id = bds.work_principal_uid 
				left join o_gea_lcam_sc_sp_pd_wticket_user user2
				on user2.user_id = bds.work_permission_uid
				left join o_gea_lcam_sc_sp_pd_wticket_user user3
				on user3.user_id = bds.ticket_sign_uid
			WHERE SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginTime}
			AND SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endTime}
			  AND UPPER(bds.work_task)  REGEXP(#{seriesIndex}) 
			  and bds.data_type='0'
			  <if test="unit != null and unit != ''">
				AND bds.name_full_path REGEXP(#{unit})
			  </if>
	union
SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
				bds.standard_result standardResult,bds.name_full_path nameFullPath,
				to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
				to_char(bds.plan_end_time) planEndTime,
				bds.org_id,bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
				bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
				to_char(bds.plan_start_time) as planStartTime,
				user1.user_name principalName,user2.user_name pmisName,
				user3.user_name signName 
				from gzpfx01.bda_analysis_statistic bds
				left join o_gea_lcam_sc_sp_pd_wticket_user user1
				on user1.user_id = bds.work_principal_uid 
				left join o_gea_lcam_sc_sp_pd_wticket_user user2
				on user2.user_id = bds.work_permission_uid
				left join o_gea_lcam_sc_sp_pd_wticket_user user3
				on user3.user_id = bds.ticket_sign_uid
			WHERE SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginTime}
			AND SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endTime}
			  AND UPPER(bds.work_task) NOT REGEXP("110KV|500KV|220KV|66KV|35KV|380V|20KV|10KV|0.4KV")
			  AND UPPER(bds.function_location_name) REGEXP(#{seriesIndex})
			  and bds.data_type='0'
			  <if test="unit != null and unit != ''">
				AND bds.name_full_path REGEXP(#{unit})
			  </if>
	</select>

	<select id="getQCCenterByNuit" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
				bds.standard_result standardResult,bds.name_full_path nameFullPath,
				to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
				to_char(bds.plan_end_time) planEndTime,
				bds.org_id,bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
				bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
				to_char(bds.plan_start_time) as planStartTime,
				user1.user_name principalName,user2.user_name pmisName,
				user3.user_name signName 
				from gzpfx01.bda_analysis_statistic bds
				left join o_gea_lcam_sc_sp_pd_wticket_user user1
				on user1.user_id = bds.work_principal_uid 
				left join o_gea_lcam_sc_sp_pd_wticket_user user2
				on user2.user_id = bds.work_permission_uid
				left join o_gea_lcam_sc_sp_pd_wticket_user user3
				on user3.user_id = bds.ticket_sign_uid
			WHERE SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginTime}
			AND SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endTime}
			AND bds.org_level = '5'
			AND bds.name_full_path REGEXP('中国南方电网有限责任公司/广州供电局有限公司/${unit}/运行部/${qcCenter}') 
			<if test="seriesIndex == 1">
				and bds.check_result = '0'
			</if>
			<if test="seriesIndex == 2">
				and bds.check_result = '0' 
				and bds.standard_result = '0'
			</if>
	</select>

	<select id="getGroupNumAndCheck" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
				bds.standard_result standardResult,bds.name_full_path nameFullPath,
				to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
				to_char(bds.plan_end_time) planEndTime,
				bds.org_id,bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
				bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
				to_char(bds.plan_start_time) as planStartTime,
				user1.user_name principalName,user2.user_name pmisName,
				user3.user_name signName 
				from gzpfx01.bda_analysis_statistic bds
				left join o_gea_lcam_sc_sp_pd_wticket_user user1
				on user1.user_id = bds.work_principal_uid 
				left join o_gea_lcam_sc_sp_pd_wticket_user user2
				on user2.user_id = bds.work_permission_uid
				left join o_gea_lcam_sc_sp_pd_wticket_user user3
				on user3.user_id = bds.ticket_sign_uid
			WHERE SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginTime}
			AND SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endTime}
			AND bds.org_level <![CDATA[>=]]> '5'
			AND bds.name_full_path REGEXP('中国南方电网有限责任公司/广州供电局有限公司/${unit}/.*/${group}.*') 
			<if test="seriesIndex == 1">
				and bds.check_result = '0'
			</if>
			<if test="seriesIndex == 2">
				and bds.check_result = '0' 
				and bds.standard_result = '0'
			</if>	
	</select>
	
	<select id="getPowerNumAndCheck" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
			SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
				bds.standard_result standardResult,bds.name_full_path nameFullPath,
				to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
				to_char(bds.plan_end_time) planEndTime,
				bds.org_id,bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
				bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
				to_char(bds.plan_start_time) as planStartTime,
				user1.user_name principalName,user2.user_name pmisName,
				user3.user_name signName 
				from gzpfx01.bda_analysis_statistic bds
				left join o_gea_lcam_sc_sp_pd_wticket_user user1
				on user1.user_id = bds.work_principal_uid 
				left join o_gea_lcam_sc_sp_pd_wticket_user user2
				on user2.user_id = bds.work_permission_uid
				left join o_gea_lcam_sc_sp_pd_wticket_user user3
				on user3.user_id = bds.ticket_sign_uid
			WHERE SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginTime}
			AND SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endTime}
			AND bds.name_full_path REGEXP('中国南方电网有限责任公司/广州供电局有限公司/${unit}/${qcCenter}/.*');	
			<if test="seriesIndex == 1">
				and bds.check_result = '0'
			</if>
			<if test="seriesIndex == 2">
				and bds.check_result = '0' 
				and bds.standard_result = '0'
			</if>	
	</select>
	
	<select id="otherDeptNumAndCheck" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT tab.*,org.name_full_path nameFullPath FROM o_gea_lcam_sys_top_organization org, 
			(SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
						bds.standard_result standardResult,
						to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
						to_char(bds.plan_end_time) planEndTime,
						bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
						bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
						to_char(bds.plan_start_time) as planStartTime,
						user1.user_name principalName,user2.user_name pmisName,
						user3.user_name signName,us.org_id orgId  FROM 
				gzpfx01.bda_analysis_statistic bds LEFT JOIN  o_gea_lcam_sys_top_user us 
				ON bds.work_permission_uid = us.user_id 
				left join o_gea_lcam_sc_sp_pd_wticket_user user1
						on user1.user_id = bds.work_principal_uid 
						left join o_gea_lcam_sc_sp_pd_wticket_user user2
						on user2.user_id = bds.work_permission_uid
						left join o_gea_lcam_sc_sp_pd_wticket_user user3
						on user3.user_id = bds.ticket_sign_uid
				WHERE  
			 bds.name_full_path LIKE '%外协单位%') tab
		WHERE tab.orgId = org.org_id
		AND org.name_full_path REGEXP(#{unit}) 
		and SUBSTRING( tab.workEndTime, 1, 10 ) <![CDATA[>=]]> #{beginTime}
			AND SUBSTRING( tab.workEndTime, 1, 10 ) <![CDATA[<=]]> #{endTime} 
		<if test="seriesIndex == 1">
			and tab.checkResult = '0'
		</if>
		<if test="seriesIndex == 2">
			and tab.checkResult = '0' 
			and tab.standardResult = '0'
		</if>
	</select>
	
	<select id="otherPersonNumAndCheck" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
				bds.standard_result standardResult,bds.name_full_path nameFullPath,
				to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
				to_char(bds.plan_end_time) planEndTime,
				bds.org_id,bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
				bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
				to_char(bds.plan_start_time) as planStartTime,
				user1.user_name principalName,user2.user_name pmisName,
				user3.user_name signName 
		FROM gzpfx01.bda_analysis_statistic bds
		LEFT JOIN  o_gea_lcam_sys_top_user us 
		ON bds.work_permission_uid = us.user_id 
		left join o_gea_lcam_sc_sp_pd_wticket_user user1
		on user1.user_id = bds.work_principal_uid 
		left join o_gea_lcam_sc_sp_pd_wticket_user user2
		on user2.user_id = bds.work_permission_uid
		left join o_gea_lcam_sc_sp_pd_wticket_user user3
		on user3.user_id = bds.ticket_sign_uid
		WHERE  AND t1.data_type='0'
		and bds.name_full_path REGEXP('外协单位.*')
		and SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginTime}
			AND SUBSTRING( bds.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endTime}
		 AND user1.user_name = #{userName}
		 <if test="seriesIndex == 1">
			and bds.check_result = '0'
		</if>
		<if test="seriesIndex == 2">
			and bds.check_result = '0' 
			and bds.standard_result = '0'
		</if>	
	</select>
	
	<select id="getOpenRoomNumAndCheck" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
				bds.standard_result standardResult,bds.name_full_path nameFullPath,
				to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
				to_char(bds.plan_end_time) planEndTime,
				bds.org_id,bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
				bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
				to_char(bds.plan_start_time) as planStartTime,
				user1.user_name principalName,user2.user_name pmisName,
				user3.user_name signName from 
		(select t.*,t3.dev_name from gzpfx01.bda_analysis_statistic t,
		(select DISTINCT t1.dev_name,t2.region_name from o_gis_g_psr_nw_net_df_dsubstation t1,
		o_gea_lcam_sc_dm_function_location t2 where SUBSTRING(t1.feederid_list,0,15) = t2.id 
		 and t2.region_name IS NOT NULL and t2.region_name=#{unit} and t1.dev_name like '%开关房%' 
		 and t1.dev_name != '开关房' and t1.dev_name != '高低压开关房') t3
		 where t.name_full_path REGEXP(#{unit}) 
		 and t.work_task like '%'||t3.dev_name||'%'
		 and t.data_type='0' 
		 and SUBSTRING( t.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginTime}
		 AND SUBSTRING( t.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endTime}) bds 
		LEFT JOIN  o_gea_lcam_sys_top_user us 
		ON bds.work_permission_uid = us.user_id 
		left join o_gea_lcam_sc_sp_pd_wticket_user user1
		on user1.user_id = bds.work_principal_uid 
		left join o_gea_lcam_sc_sp_pd_wticket_user user2
		on user2.user_id = bds.work_permission_uid
		left join o_gea_lcam_sc_sp_pd_wticket_user user3
		on user3.user_id = bds.ticket_sign_uid
		where 1=1
		 <if test="seriesIndex == 1">
			and bds.check_result = '0'
		</if>
		<if test="seriesIndex == 2">
			and bds.check_result = '0' 
			and bds.standard_result = '0'
		</if>	
	</select>
	
	
	<select id="getLineNumAndCheck" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
				bds.standard_result standardResult,bds.name_full_path nameFullPath,
				to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
				to_char(bds.plan_end_time) planEndTime,
				bds.org_id,bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
				bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
				to_char(bds.plan_start_time) as planStartTime,
				user1.user_name principalName,user2.user_name pmisName,
				user3.user_name signName from 
		(select t.* from gzpfx01.bda_analysis_statistic t,
		(SELECT DISTINCT ticket_id,bfln.function_location_name  
		FROM gzpfx01.bda_function_location_name bfln WHERE function_location_name = #{lineName}) t3
		 where  t.ticket_id=t3.ticket_id
		 and t.data_type='0'
		 and t.name_full_path REGEXP(#{unit}) 
		 and SUBSTRING( t.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginTime}
		 AND SUBSTRING( t.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endTime}) bds 
		LEFT JOIN  o_gea_lcam_sys_top_user us 
		ON bds.work_permission_uid = us.user_id 
		left join o_gea_lcam_sc_sp_pd_wticket_user user1
		on user1.user_id = bds.work_principal_uid 
		left join o_gea_lcam_sc_sp_pd_wticket_user user2
		on user2.user_id = bds.work_permission_uid
		left join o_gea_lcam_sc_sp_pd_wticket_user user3
		on user3.user_id = bds.ticket_sign_uid
		where 1=1
		 <if test="seriesIndex == 1">
			and bds.check_result = '0'
		</if>
		<if test="seriesIndex == 2">
			and bds.check_result = '0' 
			and bds.standard_result = '0'
		</if>
	
	</select>
	
	
	<select id="getMajorNumAndCheck" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
				bds.standard_result standardResult,bds.name_full_path nameFullPath,
				to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
				to_char(bds.plan_end_time) planEndTime,
				bds.org_id,bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
				bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
				to_char(bds.plan_start_time) as planStartTime,
				user1.user_name principalName,user2.user_name pmisName,
				user3.user_name signName from 
		(select t.* from gzpfx01.bda_analysis_statistic t 
		 where t.major = #{unit} 
		 and t.data_type='0'
		 AND SUBSTRING( t.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginTime}
		 AND SUBSTRING( t.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endTime}) bds 
		LEFT JOIN  o_gea_lcam_sys_top_user us 
		ON bds.work_permission_uid = us.user_id 
		left join o_gea_lcam_sc_sp_pd_wticket_user user1
		on user1.user_id = bds.work_principal_uid 
		left join o_gea_lcam_sc_sp_pd_wticket_user user2
		on user2.user_id = bds.work_permission_uid
		left join o_gea_lcam_sc_sp_pd_wticket_user user3
		on user3.user_id = bds.ticket_sign_uid
		where 1=1
		 <if test="seriesIndex == 1">
			and bds.check_result = '0'
		</if>
		<if test="seriesIndex == 2">
			and bds.check_result = '0' 
			and bds.standard_result = '0'
		</if>
	
	</select>
	
	<select id="getDeviceNumAndCheck" resultType="com.bda.bdaqm.electric.model.AnalysisStatistic">
		SELECT DISTINCT bds.ticket_id ticketId,bds.check_result checkResult,
				bds.standard_result standardResult,bds.name_full_path nameFullPath,
				to_char(bds.permission_time) as permissionTime,to_char(bds.work_end_time) workEndTime,
				to_char(bds.plan_end_time) planEndTime,
				bds.org_id,bds.org_name,bds.org_level,bds.is_delay,bds.work_task,
				bds.ticket_type,bds.function_location_name,bds.ticket_no,bds.work_state,
				to_char(bds.plan_start_time) as planStartTime,
				user1.user_name principalName,user2.user_name pmisName,
				user3.user_name signName from 
		(select t.* from gzpfx01.bda_analysis_statistic t 
		 where 1=1
		 and t.data_type='0'
		 <if test="group != null and group != ''">
				AND t.work_task REGEXP(#{group})
			</if>
			<if test="unit != null and unit != ''">
				and t.name_full_path REGEXP(#{unit})
			</if>
		 AND SUBSTRING( t.work_end_time, 1, 10 ) <![CDATA[>=]]> #{beginTime}
		 AND SUBSTRING( t.work_end_time, 1, 10 ) <![CDATA[<=]]> #{endTime}) bds 
		LEFT JOIN  o_gea_lcam_sys_top_user us 
		ON bds.work_permission_uid = us.user_id 
		left join o_gea_lcam_sc_sp_pd_wticket_user user1
		on user1.user_id = bds.work_principal_uid 
		left join o_gea_lcam_sc_sp_pd_wticket_user user2
		on user2.user_id = bds.work_permission_uid
		left join o_gea_lcam_sc_sp_pd_wticket_user user3
		on user3.user_id = bds.ticket_sign_uid
		where 1=1
		 <if test="seriesIndex == 1">
			and bds.check_result = '0'
		</if>
		<if test="seriesIndex == 2">
			and bds.check_result = '0' 
			and bds.standard_result = '0'
		</if>
	
	
	</select>
</mapper>