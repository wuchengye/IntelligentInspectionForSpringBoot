<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bda.bdaqm.electric.mapper.WorkingHoursMapper">
	
	<sql id="countTicketNum">
	    sum( case when base.ticket_type = ${ticketType} 
		          then 1
		          else 0 end
		          )
	</sql>
	
	<sql id="getTicketId">
	    CASE WHEN base.ticket_type = ${ticketType} THEN base.id END
	</sql>
	
	<select id="getCountOfTicket" resultType="map">
		select tp.person_name, 
		       tp.unit_name, 
		       max(deptment_name) deptment_name,
		       max(group_name) group_name,
		       <include refid="countTicketNum"><property name="ticketType" value="'11'"/></include> as station_one,
		       <include refid="countTicketNum"><property name="ticketType" value="'12'"/></include> as station_two,
		       <include refid="countTicketNum"><property name="ticketType" value="'13'"/></include> as station_three,
		       <include refid="countTicketNum"><property name="ticketType" value="'21'"/></include> as line_one,
		       <include refid="countTicketNum"><property name="ticketType" value="'22'"/></include> as line_two,
		       <include refid="countTicketNum"><property name="ticketType" value="'31'"/></include> as fire_one,
		       <include refid="countTicketNum"><property name="ticketType" value="'32'"/></include> as fire_two,
		       <include refid="countTicketNum"><property name="ticketType" value="'43'"/></include> as live_working,
		       <include refid="countTicketNum"><property name="ticketType" value="'44'"/></include> as low_voltage,
		       <include refid="countTicketNum"><property name="ticketType" value="'51'"/></include> as urgent_repairs,
		       <!-- <include refid="countTicketNum"><property name="ticketType" value="'61'"/></include> as safety_technology,
		       <include refid="countTicketNum"><property name="ticketType" value="'71'"/></include> as twice_measure, -->
		       <include refid="countTicketNum"><property name="ticketType" value="'81'"/></include> as written_form,
		       <!-- <include refid="countTicketNum"><property name="ticketType" value="'91'"/></include> as site_survey, -->
		       sum( case when (instr(base.work_task,'蓄电池电压') > 0 or instr(base.work_task,'铁芯及夹件接地电流') > 0 
		                       or instr(base.work_task,'小母线接地电流') > 0 or instr(base.work_task,'消防') > 0 
		                       or instr(base.work_task,'清洁绿化') > 0 or instr(base.work_task,'红外线防盗') > 0
		                       or instr(base.work_task,'空调') > 0 or instr(base.work_task,'空调') > 0 
		                       or instr(base.work_task,'小动物') > 0 or instr(base.work_task,'开关柜加热器') >0 
		                       )
		          then 1
		          else 0 end
		          ) as special
		
		  from (select distinct unit_name,
		               deptment_name,
		               group_name,
		               person_name ,
		               user_id
		          from gzpfx01.bda_three_person_temp
		          
		     left join (
		                select usr.* 
		                  from
			                 (SELECT ROW_NUMBER() over(partition by user_id order by user_id desc) as rn,*
			                  FROM o_gea_lcam_sc_sp_pd_wticket_user)usr
					     where usr.rn ='1'
		                  )
		            on user_name = person_name
		            
		         where work_principal = 1 
		           <!-- and unit_name = '变电管理三所' -->) tp
		           
     left join (select temp.* 
                  from
		               (select ROW_NUMBER() over(partition by id order by opration_time desc) as rn,
		                       id,
		                       work_task,
		                       src_operation_type,
		                       ticket_type,
		                       work_principal_uid,
		                       work_end_time,
		                       permission_time
		                  from o_gea_lcam_sc_sp_pd_wticket_base )temp
                 where temp.rn = '1' 
                       and temp.src_operation_type <![CDATA[ <> ]]> 'D'
                       <if test="param.sumStartTime != null and param.sumStartTime != ''">
                           and temp.permission_time <![CDATA[ >= ]]> #{param.sumStartTime} 
                       </if>
                       <if test="param.sumEndTime != null and param.sumEndTime != ''">
                           and temp.permission_time <![CDATA[ < ]]> #{param.sumEndTime} 
                       </if>
                  ) base
		    on tp.user_id = base.work_principal_uid
		    
		    <where>
		        <!-- <if test="param.unitName != null and param.unitName != '' and param.unitName != '广州供电局有限公司'">
		            instr(#{param.unitName},tp.unit_name) > 0 
		         or instr(#{param.unitName},tp.group_name) > 0 
		         or instr(#{param.unitName},tp.deptment_name) > 0  
		        </if> -->
		        <if test="param.unitName != null and param.unitName != '' and param.unitName != '广州供电局有限公司'">
	       		
	          <!-- unitName like '%'||#{unitName}||'%' -->
	         <choose>
	          	<when test="param.unitName != '外协单位' and  param.unitName != '其他单位' ">
					<if test="param.level lte 3">
	          			and 
	        		(select name_full_path from o_gea_lcam_sys_top_organization where org_id = #{param.orgId}) 
	        		REGEXP(tp.unit_name||'.*') 
	          		</if>
	          		<if test="param.level == 4">
	          			and 
	        		(select name_full_path from o_gea_lcam_sys_top_organization where org_id = #{param.orgId}) 
	        		REGEXP(tp.unit_name||'/'||tp.deptment_name||'.*') 
	          		</if>
	          		<if test="param.level gte 5">
	          		and 
	        		(select name_full_path from o_gea_lcam_sys_top_organization where org_id = #{param.orgId}) 
	        		REGEXP(tp.unit_name||'.*/'||tp.deptment_name||'.*/'||tp.group_name||'.*') 
	          		</if>	         		
	          	</when>
	          	<otherwise>
	          	<!-- <when test="unitName != '外协单位' and  unitName != '其他单位' ">
	         		and instr(#{unitName},unitName) > 0 
	          	</when> -->
	          	
	          		<if test="param.unitName == '其他单位'">
	          			and tp.unit_name NOT IN (select CASE WHEN instr(t1.org_name,'广州') > 0 
						THEN (SUBSTRING(t1.org_name,instr(t1.org_name,'广州')+2))
						ELSE (t1.org_name) END AS name  FROM 
						gzpfx01.bda_work_dept t2 INNER JOIN o_gea_lcam_sys_top_organization t1
						ON t1.org_id=SUBSTRING(t2.department_id,12))
	          		</if>
	          		<if test="param.unitName == '外协单位'">
	          			and tp.unit_name NOT IN (select CASE WHEN instr(t1.org_name,'广州') > 0 
						THEN (SUBSTRING(t1.org_name,instr(t1.org_name,'广州')+2))
						ELSE (t1.org_name) END AS name  FROM 
						gzpfx01.bda_work_dept t2 INNER JOIN o_gea_lcam_sys_top_organization t1
						ON t1.org_id=SUBSTRING(t2.department_id,12))
						or tp.unit_name = '南方电力建设企业集团'
	          		</if>
	          		 </otherwise>
	          </choose>
	      </if>
		    </where>
		    
      group by tp.unit_name,tp.person_name
	</select>
	
	<select id="getDetailOfAll" resultType="map">
		select tp.unit_name,
		       tp.person_name, 
		       case when (
		                  instr(base.work_task,'蓄电池电压') > 0 or instr(base.work_task,'铁芯及夹件接地电流') > 0 
                       or instr(base.work_task,'小母线接地电流') > 0 or instr(base.work_task,'消防') > 0 
                       or instr(base.work_task,'清洁绿化') > 0 or instr(base.work_task,'红外线防盗') > 0
                       or instr(base.work_task,'空调') > 0 or instr(base.work_task,'空调') > 0 
                       or instr(base.work_task,'小动物') > 0 or instr(base.work_task,'开关柜加热器') >0 
                          )then 'special'
		            else base.ticket_type
		       end as ticket_type,
		       base.id,
		       base.ticket_no ticket_no,
		       to_char(base.permission_time,'yyyy-MM-dd HH:mm:ss') permission_time,
	           to_char(base.work_end_time,'yyyy-MM-dd HH:mm:ss') work_end_time,
	           to_char(gap.gap_start_time,'yyyy-MM-dd HH:mm:ss') gap_start_time,
	           to_char(gap.gap_time,'yyyy-MM-dd HH:mm:ss') gap_time
		       <!-- <include refid="getTicketId"><property name="ticketType" value="'11'"/></include> as station_one_id,
		       <include refid="getTicketId"><property name="ticketType" value="'12'"/></include> as station_two_id,
		       <include refid="getTicketId"><property name="ticketType" value="'13'"/></include> as station_three_id,
		       <include refid="getTicketId"><property name="ticketType" value="'21'"/></include> as line_one_id,
		       <include refid="getTicketId"><property name="ticketType" value="'22'"/></include> as line_two_id,
		       <include refid="getTicketId"><property name="ticketType" value="'31'"/></include> as fire_one_id,
		       <include refid="getTicketId"><property name="ticketType" value="'32'"/></include> as fire_two_id,
		       <include refid="getTicketId"><property name="ticketType" value="'43'"/></include> as live_working_id,
		       <include refid="getTicketId"><property name="ticketType" value="'44'"/></include> as low_voltage_id,
		       <include refid="getTicketId"><property name="ticketType" value="'51'"/></include> as urgent_repairs_id,
		       <include refid="getTicketId"><property name="ticketType" value="'61'"/></include> as safety_technology_id,
		       <include refid="getTicketId"><property name="ticketType" value="'71'"/></include> as twice_measure_id,
		       <include refid="getTicketId"><property name="ticketType" value="'81'"/></include> as written_form_id,
		       <include refid="getTicketId"><property name="ticketType" value="'91'"/></include> as site_survey_id -->
		       
		
		  from (select distinct unit_name,
		               person_name ,
		               user_id
		          from gzpfx01.bda_three_person_temp
		          
		     left join (
		                select usr.* 
		                  from
			                 (SELECT ROW_NUMBER() over(partition by user_id order by user_id desc) as rn,*
			                  FROM o_gea_lcam_sc_sp_pd_wticket_user)usr
					     where usr.rn ='1'
		                  )
		            on user_name = person_name
		            
		         where work_principal = 1 
		           <!-- and unit_name = '变电管理三所' -->) tp
		           
     left join (select temp.* 
                  from
		               (select ROW_NUMBER() over(partition by id order by opration_time desc) as rn,
		                       id,
		                       work_task,
		                       ticket_no,
		                       src_operation_type,
		                       ticket_type,
		                       work_principal_uid,
		                       work_end_time,
		                       permission_time
		                  from o_gea_lcam_sc_sp_pd_wticket_base )temp
                 where temp.rn = '1' 
                       and temp.src_operation_type <![CDATA[ <> ]]> 'D'
                       <if test="param.sumStartTime != null and param.sumStartTime != ''">
                           and temp.permission_time <![CDATA[ >= ]]> #{param.sumStartTime} 
                       </if>
                       <if test="param.sumEndTime != null and param.sumEndTime != ''">
                           and temp.permission_time <![CDATA[ < ]]> #{param.sumEndTime} 
                       </if>
                  ) base
		    on tp.user_id = base.work_principal_uid
		    
     left join o_gea_lcam_sc_sp_pd_wticket_workinggap gap
            on base.id = gap.wticket_id
		 
             <if test="param.ticketType != null and param.ticketType == 'special'">
                 where instr(base.work_task,'蓄电池电压') > 0 or instr(base.work_task,'铁芯及夹件接地电流') > 0 
                       or instr(base.work_task,'小母线接地电流') > 0 or instr(base.work_task,'消防') > 0 
                       or instr(base.work_task,'清洁绿化') > 0 or instr(base.work_task,'红外线防盗') > 0
                       or instr(base.work_task,'空调') > 0 or instr(base.work_task,'空调') > 0 
                       or instr(base.work_task,'小动物') > 0 or instr(base.work_task,'开关柜加热器') >0 
             </if>
             <if test="param.ticketType != null and param.ticketType != '' and param.ticketType != 'special'">
                 where base.ticket_type = #{param.ticketType}
             </if>
		    
      group by tp.unit_name,
               tp.person_name,
               base.ticket_type,
               base.id,
               base.work_task,
               base.ticket_no,
			   base.permission_time,
	           base.work_end_time,
	           gap.gap_start_time,
	           gap.gap_time
	</select>
	
	<select id="getModulusByType" resultType="com.bda.bdaqm.electric.model.HourModulus">
        SELECT * FROM gzpfx01.BDA_HOUR_MODULUS
        <where>
	        <if test="personType != null and personType !=''">
	            type = #{personType}
	        </if>
        </where>
    </select>
    
    <update id="updateModulus">
    	update gzpfx01.BDA_HOUR_MODULUS 
    	set LIVE_WORKING = #{modulus.liveWorking},
    	    LOW_VOLTAGE = #{modulus.lowVoltage},
    	    URGENT_REPAIRS = #{modulus.urgentRepairs},
    	    WRITTEN_FORM=#{modulus.writtenForm},
    	    STATION_ONE=#{modulus.stationOne},
    	    STATION_TWO=#{modulus.stationTwo},
    	    STATION_THREE=#{modulus.stationThree},
    	    LINE_ONE=#{modulus.lineOne},
    	    LINE_TWO=#{modulus.lineTwo},
    	    FIRE_ONE=#{modulus.fireOne},
    	    FIRE_TWO=#{modulus.fireTwo},
    	    SPECIAL=#{modulus.special}
    	where type = #{modulus.type}
    </update>
    
</mapper>